{
  "hash": "f266cc60de4913f789d4e47d912fa091",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-On Exercise 05b: Visual Correlation Analysis\"\nauthor: \"Jia Peng Chua\"\ndate-modified: \"last-modified\"\nexecute:\n    echo: true\n    eval: true\n    warning: false\n    freeze: true\n---\n\n\n\n# 1. Getting Started\n\nCorrelation coefficient is commonly used to measure the type and strength of the relationship between 2 variables.\n\nThe values of a correlation coefficient ranges between -1 and 1.\n\n-   1: shows a perfect linear relationship between 2 variables\n\n-   -1: shows a perfect inverse relationship between 2 variables\n\n-   0: shows no linear relationship between 2 variables\n\nWhen multivariate data are used, the correlation coefficeints of the pair comparisons are displayed in a table form known as correlation matrix or scatterplot matrix.\n\nWhen the data is large, both in terms of the number of observations and the number of variables, [Corrgram](http://www.datavis.ca/papers/corrgram.pdf) tend to be used to visually explore and analyse the structure and the patterns of relations among variables.\n\nWe will launch `corrplot`, `ggpubr`, `plotly`, `tidyverse` in R.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(corrplot, ggstatsplot, tidyverse)\n```\n:::\n\n\n\nThe code chunk below imports the *wine_quality.csv* file into R using the `read_csv()` function of *readr* package.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine <- read_csv(\"data/wine_quality.csv\")\n```\n:::\n\n\n\n::: callout-note\nOther than `quality` and `type`, the rest of the variables are numerical and continuous data type.\n:::\n\n# 2 Building Correlation Matrix: *pairs()* method\n\nWe will create scatterplot matrix using the [*pairs*](https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/pairs.html) function of R Graphics.\n\n## 2.1 Building a basic correlation matrix\n\nThe code chunk below plots a 11 x 11 scatter plot matrix of the Wine Quality data.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(wine[,1:11])\n```\n:::\n\n\n:::\n\nThe required input of `pairs()` can be a matrix or data frame. The code chunk below plots the scatterplot matrix with columns 2 to 12 of the wine dataframe.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(wine[,2:12])\n```\n:::\n\n\n:::\n\n## 2.2 Drawing the lower corner\n\nSince a correlation matrix is symmetric, it is common to show either the upper or lower half of the matrix.\n\nThe `upper.panel` argument is used to show the lower half of the correlation matrix.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(wine[,2:12], upper.panel = NULL)\n```\n:::\n\n\n:::\n\nSimilarly, the `lower.panel` argument is used to show the upper half of the correlation matrix.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(wine[,2:12], lower.panel = NULL)\n```\n:::\n\n\n:::\n\n## 2.3 Including with correlation coefficients\n\n[`panel.cor`](https://www.rdocumentation.org/packages/xcms/versions/1.48.0/topics/panel.cor) function can be used to show the correlation coefficient of each pair of variables instead of a scatter plot. This will also show higher correlations in a larger font.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npanel.cor <- function(x, y, digits=2, prefix=\"\", cex.cor, ...) {\nusr <- par(\"usr\")\non.exit(par(usr))\npar(usr = c(0, 1, 0, 1))\nr <- abs(cor(x, y, use=\"complete.obs\"))\ntxt <- format(c(r, 0.123456789), digits=digits)[1]\ntxt <- paste(prefix, txt, sep=\"\")\nif(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)\ntext(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)\n}\n\npairs(wine[,2:12], \n      upper.panel = panel.cor)\n```\n:::\n\n\n:::\n\n# 3. Visualising Correlation Matrix: *ggcormat()*\n\nScatter plots might appear very cluttered when the number of observations is relatively large (i.e. more than 500). Corrgram data visualisation technique can be used to overcome this problem.\n\nThe are at least three R packages provide function to plot *corrgram*:\n\n-   [corrgram](https://cran.r-project.org/web/packages/corrgram/index.html)\n\n-   [ellipse](https://cran.r-project.org/web/packages/ellipse/index.html)\n\n-   [corrplot](https://cran.r-project.org/web/packages/corrplot/index.html)\n\nThe code chunk below visualises correlation matrix using `ggcorrmat()`.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggstatsplot::ggcorrmat(\n  data = wine, \n  cor.vars = 1:11)\n```\n:::\n\n\n:::\n\nThe code chunk below adds title, subtitle and aesthetic elements to the plot.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggstatsplot::ggcorrmat(\n  data = wine, \n  cor.vars = 1:11,\n  ggcorrplot.args = list(outline.color = \"black\", \n                         hc.order = TRUE,\n                         tl.cex = 10),\n  title    = \"Correlogram for wine dataset\",\n  subtitle = \"Four pairs are no significant at p < 0.05\"\n)\n```\n:::\n\n\n:::\n\n::: callout-note\n-   `cor.vars` argument is used to compute the correlation matrix needed to build the *corrgram*.\n\n-   `ggcorrplot.args` argument provide additional (mostly aesthetic) arguments that will be passed to [`ggcorrplot::ggcorrplot`](http://www.sthda.com/english/wiki/ggcorrplot-visualization-of-a-correlation-matrix-using-ggplot2) function. The list should avoid any of the following arguments since they are already internally being used: `corr`, `method`, `p.mat`, `sig.level`, `ggtheme`, `colors`, `lab`, `pch`, `legend.title`, `digits`.\n:::\n\nThe following sub-code chunk can be used to control specific component of the plot such as the font size of the x-axis, y-axis, and the statistical report.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot.component = list(\n    theme(text=element_text(size=5),\n      axis.text.x = element_text(size = 8),\n      axis.text.y = element_text(size = 8)))\n```\n:::\n\n\n\n# 4. Building Multiple Plots\n\n*ggstasplot* also supports faceting. However the feature is not available in `ggcorrmat()` but in the [`grouped_ggcorrmat()`](#0) of *ggstatsplot*.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrouped_ggcorrmat(\n  data = wine,\n  cor.vars = 1:11,\n  grouping.var = type,\n  type = \"robust\",\n  p.adjust.method = \"holm\",\n  plotgrid.args = list(ncol = 2),\n  ggcorrplot.args = list(outline.color = \"black\", \n                         hc.order = TRUE,\n                         tl.cex = 10),\n  annotation.args = list(\n    tag_levels = \"a\",\n    title = \"Correlogram for wine dataset\",\n    subtitle = \"The measures are: alcohol, sulphates, fixed acidity, citric acid, chlorides, residual sugar, density, free sulfur dioxide and volatile acidity\",\n    caption = \"Dataset: UCI Machine Learning Repository\"\n  )\n)\n```\n:::\n\n\n:::\n\n```         \n```\n\n-   To build a facet plot, the only argument needed is `grouping.var`\n\n-   Behind `group_ggcorrmat()`, *patchwork* package is used to create the multiplot. The `plotgrid.args` argument provides a list of additional arguments passed to [*patchwork::wrap_plots*](https://patchwork.data-imaginist.com/reference/wrap_plots.html), except for guides argument which is already separately specified earlier\n\n-   Likewise, `annotation.args` argument is calling [*plot annotation arguments*](https://patchwork.data-imaginist.com/reference/plot_annotation.html) of patchwork package\n\n# 5. Visualising Correlation Matrix using *corrplot* Package\n\nThis link, [An Introduction to corrplot Package](#0), provides a basic understanding of *corrplot* package.\n\n## 5.1 Getting started with *corrplot*\n\n`cor()` of R Stats is used to compute the correlation matrix of wine data frame.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine.cor <- cor(wine[, 1:11])\n```\n:::\n\n\n\nPlot the *corrgram* using [`corrplot()`](https://www.rdocumentation.org/packages/corrplot/versions/0.2-0/topics/corrplot)and the default setting.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n::: callout-note\nDefault settings:\n\n-   Visual object: circle\n\n-   Layout: symmetric matrix\n\n-   Colour scheme: diverging red-blue\n\n    -   Blue: pair variables with positive correlation coefficients\n\n    -   Red: pair variables with negative correlation coefficient\n\n    -   Darker colours: indicated relatively stronger linear relationship\n\n    -   Light colours: indicates relatively weaker linear relationship\n:::\n\n## 5.2 Working with visual geometrics\n\nThere are 7 visual geometrics (parameter method) that can be used to encode the attribute values:\n\n-   `circle` (default)\n\n-   `square`\n\n-   `ellipse`\n\n-   `number`\n\n-   `shade`\n\n-   `color`\n\n-   `pie`\n\nThe code chunk below changes the `method`.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\")\n```\n:::\n\n\n:::\n\n## 5.3 Working with layout\n\n*corrplot* supports3 layout types:\n\n-   `full`: displays full matrix\n\n-   `upper`: displays lower matrix\n\n-   `lower`: displays upper matrix\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         type=\"lower\")\n```\n:::\n\n\n:::\n\nThe arguments `diag` and `tl.col` can be used to turn off the diagonal cells and change the colour of the axis text label.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         type=\"lower\",\n         diag = FALSE,\n         tl.col = \"black\")\n```\n:::\n\n\n:::\n\n## 5.4 Working with mixed layout\n\n[`corrplot.mixed()`](https://www.rdocumentation.org/packages/corrplot/versions/0.84/topics/corrplot.mixed), a wrapped function for mixed visualisation style can be used to create coorgram with mixed layout.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot.mixed(wine.cor, \n               lower = \"ellipse\", \n               upper = \"number\",\n               tl.pos = \"lt\",\n               diag = \"l\",\n               tl.col = \"black\")\n```\n:::\n\n\n:::\n\n## 5.5 Combining corrgram with the significant test\n\n`cor.mtest()` can be used to compute p-vales and confidence interval fro each pair of variables.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine.sig = cor.mtest(wine.cor, conf.level= .95)\n```\n:::\n\n\n\n`p.mat` argument helps to filter out correlation coefficients that are not statistically significant.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor,\n         method = \"number\",\n         type = \"lower\",\n         diag = FALSE,\n         tl.col = \"black\",\n         tl.srt = 45,\n         p.mat = wine.sig$p,\n         sig.level = .05)\n```\n:::\n\n\n:::\n\n## 5.6 Reorder a corrgram\n\n`order` argument helps to overwrite the default sorting setting. Other values include:\n\n-   “AOE”: angular order of the eigenvectors\n\n-   “FPC”: first principal component order\n\n-   “hclust”: hierarchical clustering order\n\n-   “hclust.method”: agglomeration method to be used\n\n    -   “hclust.method” should be one of “ward”, “single”, “complete”, “average”, “mcquitty”, “median” or “centroid”\n\n-   “alphabet”: alphabetical order\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot.mixed(wine.cor, \n               lower = \"ellipse\", \n               upper = \"number\",\n               tl.pos = \"lt\",\n               diag = \"l\",\n               order=\"AOE\",\n               tl.col = \"black\")\n```\n:::\n\n\n:::\n\n## 5.7 **Reordering a correlation matrix using hclust**\n\nRectangles can be drawn based on the results of hierarchical clustering, using `order = \"hclust\"`.\n\n::: panel-tabset\n#### The plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n\n\n#### The code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         tl.pos = \"lt\",\n         tl.col = \"black\",\n         order=\"hclust\",\n         hclust.method = \"ward.D\",\n         addrect = 3)\n```\n:::\n\n\n:::\n\n[^1]\n\n[^1]: This document was completed with reference to:\n\n    -   Prof Kam's notes \"Visual Correlation Analysis\": <https://r4va.netlify.app/chap06>\n",
    "supporting": [
      "Hands-on_Ex05b_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}